<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Study Timetable with White Noise</title>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    display: flex;
    height: 100vh;
  }
  #left {
    width: 30%;
    background: #111;
    color: white;
    padding: 20px;
  }
  #left h2 {
    margin-top: 0;
    letter-spacing: 2px;
  }
  .item {
    margin: 10px 0;
    opacity: 0.4;
  }
  .active {
    opacity: 1;
    font-weight: bold;
  }
  #right {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: #f5f5f5;
  }
  #time {
    font-size: 64px;
    margin-bottom: 20px;
  }
  button {
    font-size: 18px;
    padding: 10px 20px;
    margin: 5px; /* ë²„íŠ¼ ê°„ ê°„ê²© ì¶”ê°€ */
  }
</style>
</head>

<body>

<div id="left">
  <h2>TIMETABLE</h2>
  <div id="schedule"></div>
</div>

<div id="right">
  <div id="time">--:--:--</div>
  <button onclick="ensureAudioContextAndPlayBell()">ğŸ”” ì¢…ì†Œë¦¬ í…ŒìŠ¤íŠ¸</button>
  <button onclick="toggleWhiteNoise()" id="whiteNoiseButton">ğŸ˜´ ë°±ìƒ‰ì†ŒìŒ ì¼œê¸°</button>
</div>

<script>
let audioCtx = null; // ëª¨ë“  ì˜¤ë””ì˜¤ì— ì‚¬ìš©í•  ë‹¨ì¼ AudioContext

// AudioContextê°€ ì—†ìœ¼ë©´ ìƒì„±í•˜ê³ , í™œì„±í™” ìƒíƒœì¸ì§€ í™•ì¸
function getOrCreateAudioContext() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  // suspend ìƒíƒœì¼ ê²½ìš° resume (ì‚¬ìš©ì ì œìŠ¤ì²˜ê°€ ìˆì–´ì•¼ í•¨)
  if (audioCtx.state === 'suspended') {
    audioCtx.resume().catch(e => console.error("AudioContext resume failed:", e));
  }
  return audioCtx;
}

/* ====== ì‚¬ìš´ë“œ ====== */
let soundEnabled = false;

// ì¢…ì†Œë¦¬ í™œì„±í™” ë° ì¬ìƒ ì‹œì‘
function ensureAudioContextAndPlayBell() {
  getOrCreateAudioContext(); // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ê°€ ì¡´ì¬í•˜ê³  í™œì„±í™”ë˜ë„ë¡ í•¨
  playMelody();
  soundEnabled = true;
  alert("ì¢…ì†Œë¦¬ í™œì„±í™” ì™„ë£Œ");
}

/* ğŸµ ë©œë¡œë”” (0 = ì‰¼í‘œ) - ë ˆì¥ì¡° ê¸°ë°˜ */
const melody = [
  // ë ˆì¥ì¡° 'ë„ë¯¸ì†”ë¯¸ ë„ë¯¸ì†”ë¯¸' (ì‹¤ì œ ìŒì€ ë ˆ-íŒŒ#-ë¼-íŒŒ# ë ˆ-íŒŒ#-ë¼-íŒŒ#)
  293.66, 369.99, 440.00, 369.99, // D4(ë ˆ) F#4(íŒŒ#) A4(ë¼) F#4(íŒŒ#)
  293.66, 369.99, 440.00, 369.99, // D4(ë ˆ) F#4(íŒŒ#) A4(ë¼) F#4(íŒŒ#)

  // ë†’ì€ ë ˆì¥ì¡° ìŠ¤ì¼€ì¼ í•˜í–‰ 'ë„ ì‹œ ë¼ ì†” íŒŒ ë¯¸ ë ˆ ë„' (ì‹¤ì œ ìŒì€ ë†’ì€ ë ˆ-ë„#-ì‹œ-ë¼-ì†”-íŒŒ#-ë¯¸-ë ˆ)
  587.33, // D5(ë†’ì€ ë ˆ)
  554.37, // C#5(ë†’ì€ ë„#)
  493.88, // B4(ì‹œ)
  440.00, // A4(ë¼)
  392.00, // G4(ì†”)
  369.99, // F#4(íŒŒ#)
  329.63, // E4(ë¯¸)
  293.66, // D4(ë ˆ)

  // ë„(ì‰¬ê³ )(ë‚®ì€)ì‹œ(ì‰¬ê³ )ë„ (ì‹¤ì œ ìŒì€ ë ˆ(ì‰¬ê³ )ë„#(ì‰¬ê³ )ë ˆ)
  293.66, // D4(ë ˆ)
  0,      // ì‰¼í‘œ
  277.18, // C#4(ë„#) - 'ë‚®ì€ ì‹œ' ëŠë‚Œ
  0,      // ì‰¼í‘œ
  293.66  // D4(ë ˆ)
];


function playMelody() {
  if (!audioCtx) {
    console.warn("AudioContext not initialized for melody.");
    return;
  }
  let t = audioCtx.currentTime;

  // 120 BPMì— ë§ì¶° í…œí¬ ì¡°ì •
  // 1ë¶„(60ì´ˆ) = 120ë°•ì -> 1ë°•ì(4ë¶„ìŒí‘œ) = 0.5ì´ˆ
  // 8ë¶„ìŒí‘œ ê°„ê²©ìœ¼ë¡œ ìƒê°í•´ì„œ, ê° ìŒì •ì´ ì‹œì‘ë˜ëŠ” ê°„ê²©(stepDuration)ì„ 0.25ì´ˆë¡œ ì¡°ì •
  const noteDuration = 0.22; // ìŒì´ ì‹¤ì œë¡œ ìš¸ë¦¬ëŠ” ì‹œê°„ (0.25ì´ˆë³´ë‹¤ ì•½ê°„ ì§§ê²Œ)
  const stepDuration = 0.25; // ë‹¤ìŒ ìŒì´ ì‹œì‘ë  ë•Œê¹Œì§€ì˜ ì´ ì‹œê°„ (8ë¶„ìŒí‘œ ê°„ê²©)

  melody.forEach(freq => {
    if (freq === 0) {
      // ì‰¼í‘œë„ ë™ì¼í•œ ë°•ìë¡œ
      t += stepDuration;
      return;
    }

    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    osc.type = "triangle"; // ì¢… ëŠë‚Œ
    osc.frequency.value = freq;

    gain.gain.setValueAtTime(0.3, t);
    gain.gain.exponentialRampToValueAtTime(0.001, t + noteDuration);

    osc.connect(gain);
    gain.connect(audioCtx.destination);

    osc.start(t);
    osc.stop(t + noteDuration);

    t += stepDuration; // ë‹¤ìŒ ìŒì˜ ì‹œì‘ ì‹œê°„ìœ¼ë¡œ ì´ë™
  });
}

/* ====== ë°±ìƒ‰ì†ŒìŒ ====== */
let whiteNoiseSource = null;
let whiteNoiseGainNode;

function toggleWhiteNoise() {
  const button = document.getElementById('whiteNoiseButton');
  getOrCreateAudioContext(); // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ê°€ ì¡´ì¬í•˜ê³  í™œì„±í™”ë˜ë„ë¡ í•¨

  if (whiteNoiseSource) { // ë°±ìƒ‰ì†ŒìŒì´ ì¬ìƒ ì¤‘ì´ë©´ ì¤‘ì§€
    whiteNoiseSource.stop(); // ScriptProcessorNodeëŠ” stop() í˜¸ì¶œ ê°€ëŠ¥
    whiteNoiseSource.disconnect();
    whiteNoiseGainNode.disconnect();
    whiteNoiseSource = null;
    button.textContent = "ğŸ˜´ ë°±ìƒ‰ì†ŒìŒ ì¼œê¸°";
    console.log("ë°±ìƒ‰ì†ŒìŒ ì¤‘ì§€");
  } else { // ë°±ìƒ‰ì†ŒìŒì´ ì¬ìƒ ì¤‘ì´ ì•„ë‹ˆë©´ ì‹œì‘
    // ScriptProcessorNode (deprecatedì§€ë§Œ ê°„ë‹¨í•œ ë°±ìƒ‰ì†ŒìŒ êµ¬í˜„ì— ì‚¬ìš©)
    whiteNoiseSource = audioCtx.createScriptProcessor(4096, 0, 1);
    whiteNoiseSource.onaudioprocess = function(e) {
      const output = e.outputBuffer.getChannelData(0);
      for (let i = 0; i < output.length; i++) {
        output[i] = Math.random() * 2 - 1; // -1ì—ì„œ 1 ì‚¬ì´ì˜ ëœë¤ ê°’ìœ¼ë¡œ ë°±ìƒ‰ì†ŒìŒ ìƒì„±
      }
    };

    whiteNoiseGainNode = audioCtx.createGain();
    whiteNoiseGainNode.gain.value = 0.02; // ë°±ìƒ‰ì†ŒìŒ ë³¼ë¥¨ ì¡°ì ˆ (ë” ë‚®ì¶¤)

    whiteNoiseSource.connect(whiteNoiseGainNode);
    whiteNoiseGainNode.connect(audioCtx.destination);
    // Note: ScriptProcessorNodeì˜ start()ëŠ” ëª…ì‹œì ìœ¼ë¡œ í˜¸ì¶œí•  í•„ìš” ì—†ìŒ, connect() ë˜ë©´ ì‹œì‘ë¨
    // ë‹¤ë§Œ, ì›¹í‚· ê¸°ë°˜ ë¸Œë¼ìš°ì €ì—ì„œ ë¬¸ì œ ë°œìƒ ì‹œ `whiteNoiseSource.buffer = audioCtx.createBuffer(1, 4096, audioCtx.sampleRate); whiteNoiseSource.loop = true;` ë“±ìœ¼ë¡œ ëŒ€ì²´ ì‹œë„

    button.textContent = "ğŸ”Š ë°±ìƒ‰ì†ŒìŒ ë„ê¸°";
    console.log("ë°±ìƒ‰ì†ŒìŒ ì‹œì‘");
  }
}

/* ====== ì‹œê°„í‘œ ====== */
const timetable = [
  { name: "1êµì‹œ", start: "08:40", end: "10:00" }, // 80ë¶„
  { name: "ì‰¬ëŠ”ì‹œê°„", start: "10:00", end: "10:20" }, // 20ë¶„
  { name: "2êµì‹œ", start: "10:20", end: "11:30" }, // 70ë¶„
  { name: "ì ì‹¬", start: "11:30", end: "12:30" },    // 60ë¶„ (ê³ ì •)
  { name: "3êµì‹œ", start: "12:30", end: "13:40" }, // 70ë¶„
  { name: "ì‰¬ëŠ”ì‹œê°„", start: "13:40", end: "14:00" }, // 20ë¶„
  { name: "4êµì‹œ", start: "14:00", end: "15:10" },  // 70ë¶„
  { name: "ì‰¬ëŠ”ì‹œê°„", start: "15:10", end: "15:30" }, // 20ë¶„
  { name: "5êµì‹œ", start: "15:30", end: "16:30" }  // 60ë¶„
];

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œê°„í‘œ í•­ëª©ë“¤ì„ í•œ ë²ˆë§Œ ìƒì„±
document.addEventListener("DOMContentLoaded", () => {
  const scheduleBox = document.getElementById("schedule");
  timetable.forEach((t, index) => {
    const div = document.createElement("div");
    div.className = "item";
    div.id = `item-${index}`; // ê³ ìœ  ID ì¶”ê°€
    div.textContent = `${t.name} ${t.start}â€“${t.end}`;
    scheduleBox.appendChild(div);
  });
  // ì´ˆê¸° ì‹œê°„ í‘œì‹œ
  tick();
});

function tick() {
  const now = new Date();
  const h = String(now.getHours()).padStart(2,"0");
  const m = String(now.getMinutes()).padStart(2,"0");
  const s = String(now.getSeconds()).padStart(2,"0");
  const hm = `${h}:${m}`;

  document.getElementById("time").innerText = `${h}:${m}:${s}`;

  timetable.forEach((t, index) => {
    const itemDiv = document.getElementById(`item-${index}`); // ê³ ìœ  IDë¡œ ìš”ì†Œë¥¼ ê°€ì ¸ì˜´
    if (itemDiv) { // ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
      if (hm >= t.start && hm < t.end) {
        itemDiv.classList.add("active");
      } else {
        itemDiv.classList.remove("active");
      }
    }

    // ì¢…ì†Œë¦¬ í™œì„±í™” ìƒíƒœì´ê³  ì •ê°ì´ ë˜ë©´ ë©œë¡œë”” ì¬ìƒ
    // soundEnabledê°€ trueì—¬ì•¼ í•˜ê³ , ì •í™•íˆ t.start ì‹œê°„ì— sê°€ "00"ì´ì–´ì•¼ í•¨
    if (soundEnabled && s === "00" && hm === t.start) {
        playMelody(); // ì´ë¯¸ getOrCreateAudioContext()ì™€ soundEnabledê°€ ensureAudioContextAndPlayBell()ì—ì„œ ì²˜ë¦¬ë˜ë¯€ë¡œ playMelodyë§Œ í˜¸ì¶œ
    }
  });
}

setInterval(tick, 1000);
</script>

</body>
</html>
